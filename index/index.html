<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šç¤ºæ³¢å™¨</title>
    <link rel="icon" href="favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼·åˆ¶ä½¿ç”¨å¾®è»Ÿæ­£é»‘é«” */
        body {
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: #0f172a; /* æ·±è—è‰²èƒŒæ™¯ï¼Œè®“æ³¢å½¢æ›´æ˜é¡¯ */
            overflow: hidden; /* é˜²æ­¢æ»¾å‹• */
        }

        /* ç¤ºæ³¢å™¨è¢å¹•çš„æƒæç·šæ•ˆæœ */
        .crt-screen {
            background: radial-gradient(circle, #1e293b 0%, #020617 100%);
            border: 2px solid #334155;
            box-shadow: inset 0 0 20px #000000;
            position: relative;
        }

        /* ç¶²æ ¼èƒŒæ™¯ */
        .grid-bg {
            background-image: 
                linear-gradient(rgba(173, 216, 230, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(173, 216, 230, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        /* ä¸­å¿ƒç·šå¼·èª¿ */
        .grid-center-x {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: rgba(173, 216, 230, 0.4);
        }
        .grid-center-y {
            position: absolute;
            left: 50%;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: rgba(173, 216, 230, 0.4);
        }

        /* æ§åˆ¶é¢æ¿ç»ç’ƒæ“¬æ…‹ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* è‡ªå®šç¾©æ»‘æ¡¿æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #FFF44F; /* æª¸æª¬é»ƒ */
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ADD8E6; /* æ·¡è— */
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-white h-screen flex flex-col">

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç‹€æ…‹ -->
    <header class="p-4 flex justify-between items-center bg-slate-900/80 z-10">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse" id="status-dot"></div>
            <h1 class="text-xl font-bold tracking-wider text-cyan-300">AUDIO OSCILLOSCOPE</h1>
        </div>
        <div class="text-sm font-mono text-yellow-300" id="fps-counter">FPS: 0</div>
    </header>

    <!-- ä¸»è¦ç¤ºæ³¢å™¨é¡¯ç¤ºå€åŸŸ -->
    <main class="flex-grow relative flex justify-center items-center p-4">
        <div class="crt-screen w-full h-full rounded-lg overflow-hidden relative" id="canvas-container">
            <!-- èƒŒæ™¯ç¶²æ ¼ -->
            <div class="grid-bg"></div>
            <div class="grid-center-x"></div>
            <div class="grid-center-y"></div>
            
            <!-- ç¹ªåœ–ç•«å¸ƒ -->
            <canvas id="oscilloscope" class="absolute top-0 left-0 z-10"></canvas>
            
            <!-- å•Ÿå‹•æç¤ºè¦†è“‹å±¤ -->
            <div id="start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 z-20 backdrop-blur-sm">
                <p class="mb-4 text-cyan-200 text-lg">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ“·å–éº¥å…‹é¢¨éŸ³è¨Š</p>
                <button id="start-btn" class="px-8 py-3 bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold rounded-full transition-all transform hover:scale-105 shadow-[0_0_15px_rgba(34,211,238,0.5)]">
                    å•Ÿå‹•ç¤ºæ³¢å™¨ ğŸ™ï¸
                </button>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨æ§åˆ¶é¢æ¿ -->
    <footer class="glass-panel p-6 pb-8">
        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- æ§åˆ¶é … 1: å¢ç›Š (Gain/Zoom Y) -->
            <div class="flex flex-col gap-2">
                <label class="text-sm text-cyan-200 font-bold flex justify-between">
                    <span>å‚ç›´æŒ¯å¹… (Gain)</span>
                    <span id="gain-val" class="text-yellow-300">1.0x</span>
                </label>
                <input type="range" id="gain-control" min="0.5" max="5.0" step="0.1" value="1.5" class="w-full">
            </div>

            <!-- æ§åˆ¶é … 2: ç·šæ¢ç²—ç´° -->
            <div class="flex flex-col gap-2">
                <label class="text-sm text-cyan-200 font-bold flex justify-between">
                    <span>ç·šæ¢ç²—ç´°</span>
                    <span id="width-val" class="text-yellow-300">3px</span>
                </label>
                <input type="range" id="width-control" min="1" max="10" step="0.5" value="3" class="w-full">
            </div>

            <!-- æ§åˆ¶é … 3: é¡è‰²åˆ‡æ› (éš±è—åŠŸèƒ½ï¼Œé è¨­æª¸æª¬é»ƒ) -->
            <div class="flex flex-col gap-2">
                <label class="text-sm text-cyan-200 font-bold">æ³¢å½¢é¡è‰²</label>
                <div class="flex gap-4">
                    <button class="color-btn w-8 h-8 rounded-full bg-[#FFF44F] ring-2 ring-offset-2 ring-offset-slate-900 ring-yellow-300 transition-transform hover:scale-110" data-color="#FFF44F" title="æª¸æª¬é»ƒ"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-[#ADD8E6] transition-transform hover:scale-110 opacity-70 hover:opacity-100" data-color="#ADD8E6" title="æ·¡è—"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-[#FF69B4] transition-transform hover:scale-110 opacity-70 hover:opacity-100" data-color="#FF69B4" title="éœ“è™¹ç²‰"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-[#00FF00] transition-transform hover:scale-110 opacity-70 hover:opacity-100" data-color="#00FF00" title="é§­å®¢ç¶ "></button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // DOM å…ƒç´ 
        const canvas = document.getElementById('oscilloscope');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');
        const statusDot = document.getElementById('status-dot');
        const gainSlider = document.getElementById('gain-control');
        const gainVal = document.getElementById('gain-val');
        const widthSlider = document.getElementById('width-control');
        const widthVal = document.getElementById('width-val');
        const fpsCounter = document.getElementById('fps-counter');
        const colorBtns = document.querySelectorAll('.color-btn');

        // éŸ³è¨Šè®Šæ•¸
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let source;
        let isRunning = false;
        let animationId;

        // è¨­å®šè®Šæ•¸
        let waveColor = '#FFF44F'; // é è¨­æª¸æª¬é»ƒ
        let lineWidth = 3;
        let gain = 1.5;

        // åˆå§‹åŒ– Canvas å°ºå¯¸
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // å•Ÿå‹•éŸ³è¨ŠåŠŸèƒ½
        async function initAudio() {
            try {
                // 1. å»ºç«‹ AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 2. ç²å–éº¥å…‹é¢¨æ¬Šé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 3. å»ºç«‹åˆ†æå™¨
                analyser = audioContext.createAnalyser();
                // fftSize æ±ºå®šäº†è§£æåº¦ï¼Œ2048 æ˜¯ä¸€å€‹å¾ˆå¥½çš„å¹³è¡¡é»
                analyser.fftSize = 2048; 
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // 4. é€£æ¥ç¯€é»
                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                // æ³¨æ„ï¼šä¸è¦é€£æ¥åˆ° audioContext.destinationï¼Œå¦å‰‡æœƒè½åˆ°å›éŸ³å˜¯å«ï¼

                // UI æ›´æ–°
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 300);
                statusDot.classList.remove('bg-red-500');
                statusDot.classList.add('bg-green-500');
                
                isRunning = true;
                draw();

            } catch (err) {
                console.error('ç„¡æ³•å­˜å–éº¥å…‹é¢¨:', err);
                alert('ç³Ÿç³•ï¼ç„¡æ³•å­˜å–éº¥å…‹é¢¨ã€‚è«‹ç¢ºä¿ä½ å…è¨±äº†æ¬Šé™ï¼Œä¸¦æª¢æŸ¥éº¥å…‹é¢¨è¨­å®šã€‚');
            }
        }

        // è§¸ç™¼ç®—æ³• (Triggering) - è®“æ³¢å½¢ç©©å®šé¡¯ç¤ºçš„é—œéµ
        // å°‹æ‰¾æ³¢å½¢å‘ä¸Šç©¿éé›¶é»çš„ä½ç½®ï¼Œä½œç‚ºç¹ªè£½çš„èµ·é»
        function findZeroCrossing(buf, buflen) {
            let i = 0;
            let last_zero = -1;
            let t;

            // ç¨å¾®æé«˜é–¾å€¼ä»¥éæ¿¾é›œè¨Š
            // 128 æ˜¯ 8-bit éŸ³è¨Šçš„éœéŸ³é» (0~255 çš„ä¸­é–“)
            
            // å…ˆå¿«é€²åˆ°æ³¢å½¢ä½æ–¼ 128 çš„åœ°æ–¹
            while (i < buflen && (buf[i] > 128)) {
                i++;
            }

            if (i >= buflen) return 0;

            // å†å°‹æ‰¾æ³¢å½¢ç©¿é 128 è®Šé«˜çš„åœ°æ–¹
            while (i < buflen && ((t = buf[i]) < 128)) {
                i++;
            }

            if (i >= buflen) return 0;

            return i;
        }

        // ç¹ªåœ–å¾ªç’°
        let lastTime = 0;
        function draw(timestamp) {
            if (!isRunning) return;
            
            // è¨ˆç®— FPS
            if (timestamp) {
                const fps = Math.round(1000 / (timestamp - lastTime));
                if (timestamp % 10 === 0) fpsCounter.innerText = `FPS: ${fps}`; // æ¸›å°‘æ›´æ–°é »ç‡
                lastTime = timestamp;
            }

            animationId = requestAnimationFrame(draw);

            // ç²å–æ™‚åŸŸæ•¸æ“š (Time Domain Data) - é€™æ˜¯æ³¢å½¢çš„é—œéµ
            analyser.getByteTimeDomainData(dataArray);

            // æ¸…é™¤ç•«å¸ƒ
            ctx.fillStyle = 'rgba(15, 23, 42, 1)'; // èˆ‡èƒŒæ™¯è‰²ç›¸åŒï¼Œå®Œå…¨è¦†è“‹ä»¥æ¸…é™¤ä¸Šä¸€å¹€
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è¨­å®šç·šæ¢æ¨£å¼
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = waveColor;
            ctx.lineJoin = 'round';
            
            // æ·»åŠ è¢å…‰æ•ˆæœ (Glow Effect)
            ctx.shadowBlur = 10;
            ctx.shadowColor = waveColor;

            ctx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            
            // æ‡‰ç”¨è§¸ç™¼ç®—æ³•ä¾†ç©©å®šæ³¢å½¢
            // å¦‚æœæˆ‘å€‘åªå¾ dataArray[0] é–‹å§‹ç•«ï¼Œæ³¢å½¢æœƒå› ç‚ºç›¸ä½ä¸åŒè€Œå·¦å³æŠ–å‹•
            let startOffset = findZeroCrossing(dataArray, bufferLength);

            // å¦‚æœæ‰¾ä¸åˆ°éé›¶é»ï¼ˆä¾‹å¦‚å®Œå…¨éœéŸ³ï¼‰ï¼Œå°±å¾é ­é–‹å§‹
            if (startOffset === 0) startOffset = 0;

            // ç‚ºäº†è®“æ³¢å½¢åœ¨ç•«é¢ä¸­å±•é–‹ï¼Œæˆ‘å€‘å¯ä»¥èª¿æ•´æ­¥é•·
            // é€™è£¡ä½¿ç”¨ç°¡å–®çš„é‚è¼¯ï¼šç¹ªè£½å¾è§¸ç™¼é»é–‹å§‹çš„ä¸€æ®µ
            
            // è¨ˆç®—ä¸­å¿ƒç·š (128 æ˜¯ 8bit éŸ³è¨Šçš„éœéŸ³å€¼)
            const centerY = canvas.height / 2;

            for (let i = startOffset; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0; // æ­£è¦åŒ– 0~2 ä¹‹é–“ (1æ˜¯éœéŸ³)
                const y = centerY + (v - 1) * centerY * gain; // æ‡‰ç”¨ Gain æ”¾å¤§æŒ¯å¹…

                if (i === startOffset) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // x è»¸æ¨é€²ï¼Œå¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´ç¸®æ”¾ä¿‚æ•¸
                x += sliceWidth * 2; // *2 è®“æ³¢å½¢æ©«å‘æ‹‰é•·ä¸€é»ï¼Œæ›´å®¹æ˜“çœ‹æ¸…
                
                // å¦‚æœç•«å‡ºè¢å¹•äº†å°±åœæ­¢
                if (x > canvas.width) break;
            }

            ctx.stroke();
            
            // ç¹ªè£½ä¸€æ¢æ·¡æ·¡çš„æ°´å¹³åŸºæº–ç·š
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(173, 216, 230, 0.2)'; // æ·¡è—è‰²ï¼Œå¾ˆé€æ˜
            ctx.lineWidth = 1;
            ctx.shadowBlur = 0;
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }

        // äº‹ä»¶ç›£è½å™¨
        startBtn.addEventListener('click', initAudio);

        gainSlider.addEventListener('input', (e) => {
            gain = parseFloat(e.target.value);
            gainVal.innerText = gain.toFixed(1) + 'x';
        });

        widthSlider.addEventListener('input', (e) => {
            lineWidth = parseInt(e.target.value);
            widthVal.innerText = lineWidth + 'px';
        });

        // é¡è‰²åˆ‡æ›é‚è¼¯
        colorBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // æ›´æ–°é¡è‰²
                waveColor = e.target.dataset.color;
                
                // æ›´æ–° UI ç‹€æ…‹ (Ring effect)
                colorBtns.forEach(b => {
                    b.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-slate-900', 'ring-yellow-300', 'ring-cyan-300', 'ring-pink-300', 'ring-green-300');
                    b.classList.add('opacity-70');
                });
                e.target.classList.remove('opacity-70');
                e.target.classList.add('ring-2', 'ring-offset-2', 'ring-offset-slate-900');
                
                // æ ¹æ“šé¡è‰²çµ¦äºˆä¸åŒçš„ ring color
                if (waveColor === '#FFF44F') e.target.classList.add('ring-yellow-300');
                else if (waveColor === '#ADD8E6') e.target.classList.add('ring-cyan-300');
                else if (waveColor === '#FF69B4') e.target.classList.add('ring-pink-300');
                else e.target.classList.add('ring-green-300');
            });
        });

    </script>
</body>
</html>